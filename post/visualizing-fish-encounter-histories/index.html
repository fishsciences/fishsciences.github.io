	
	<!doctype html>
<html lang="en">
  <head>    
    <title>Practical Pisces - Visualizing Fish Encounter Histories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

    
    <link href="/css/milk.min.css" rel="stylesheet">
    <link href="/css/milk-responsive.min.css" rel="stylesheet">     
    <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/fonts.css" rel="stylesheet" type="text/css" media="all">
    <link rel="shortcut icon" href="/images/logo2.ico"> 
    <link rel="apple-touch-icon" href="">
    <link rel="canonical" href="/post/visualizing-fish-encounter-histories/">

    
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Practical Pisces">    

  </head>
  <body>    
    <div class="navbar navbar-fixed-top">        
  <div id="navbar-inner">
          <div id="logo">
            <a href=""><img src="/images/logo2.png" width="100px" hspace="5px" vspace="25px"></img></a>
          </div>
  </div>
</div>


<div class="container">
  <div class="content">
    <div class="row-fluid">
      <div class="span12">
        <div class="posts">
      

	    
	  <div class="post">
	    <header class="post-header">
	        <h1><a href="/post/visualizing-fish-encounter-histories/">Visualizing Fish Encounter Histories</a></h1>
	        <div class="post-time">January 5 2018</div>
	    </header>
	    <div class="post-after">
	        <div class="tags">
	            
	                <a href="//tags/viz">viz</a>              
	            
	                <a href="//tags/ggplot2">ggplot2</a>              
	            
	        </div>
	    </div>
	    <hr>
	    <div class="post content">
	        <p>When working with acoustically-tagged fish, we often want to generate a record of each fish’s “encounters” with the acoustic receivers (also called monitors) in an array. If this in no way applies to your work, you can think of an encounter history as a simple set of Bernoulli trials for each fish, with successes (1s) or failures (0s). These encounter histories are simply the translation of a fish’s path into a row of 1s and 0s, each corresponding to a positive or negative detection record at a receiver location in the acoustic array.</p>
<p>An encounter history <code>dataframe</code> might look like this:</p>
<pre><code>##    TagID Release I80_1 Lisbon Rstr Base_TD BCE BCW MAE MAW
## 1   4842       1     1      1    1       1   1   1   1   1
## 2   4843       1     1      1    1       1   1   1   1   1
## 3   4844       1     1      1    1       1   1   1   1   1
## 4   4845       1     1      1    1       1   0   0   0   0
## 5   4847       1     1      1    0       0   0   0   0   0
## 6   4848       1     1      1    1       0   0   0   0   0
## 7   4849       1     1      0    0       0   0   0   0   0
## 8   4850       1     1      0    1       1   1   1   0   0
## 9   4851       1     1      0    0       0   0   0   0   0
## 10  4854       1     1      0    0       0   0   0   0   0</code></pre>
<p>Where each row represents a different tagged fish, and each column represents a different receiver location, ordered from the most upstream (the “Release” station“) to the most downstream (in this case, Station”MAW“). A”1&quot; indicates a successful detection at that receiver, and a 0 represents a lack of detection. A <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidied</a> version of this data is in the code below.</p>
<p>A typical pattern of encounter histories for outmigrating juvenile fish is to see the detection rate decline across fish as they migrate downstream and succumb to predation or other mortality factors. However, some fish will miss one monitor only to be detected at one or more monitors downstream. Because the missed monitors (which look like 0s or NAs in the dataset) are just as important as the hit monitors, we want to include them in our visualizations.</p>
<p>The following code will allow you to download the sample data and visualize it with ggplot2, provided you have all the packages listed below installed. The visualization we’ve chosen is one that utilizes <code>geom_path()</code> to connect each fish’s string of encounters together.</p>
<pre class="r"><code>library(tidyverse)

# download sample data; note that the destfile path defaults to your root directory; adjust filepath as necessary.
download.file(&#39;https://github.com/Myfanwy/ReproducibleExamples/raw/master/encounterhistories/fishdata.csv&#39;, destfile = &quot;fishdata.csv&quot;)

(d &lt;- read_csv(&quot;fishdata.csv&quot;))</code></pre>
<pre><code>## # A tibble: 209 x 3
##    TagID Station value
##    &lt;int&gt;   &lt;chr&gt; &lt;int&gt;
##  1  4842 Release     1
##  2  4843 Release     1
##  3  4844 Release     1
##  4  4845 Release     1
##  5  4847 Release     1
##  6  4848 Release     1
##  7  4849 Release     1
##  8  4850 Release     1
##  9  4851 Release     1
## 10  4854 Release     1
## # ... with 199 more rows</code></pre>
<p>The dataframe <code>d</code> now has TagID and Station (monitor) as columns, and the 1/0 detection indicator as the <code>value</code> column.</p>
<p>First, it’s easier to work with both the TagIDs and monitors if they’re ordered factors:</p>
<pre class="r"><code>encounters &lt;- mutate(d,
                     TagID = factor(TagID),
                     Monitor = factor(Station, levels = unique(d$Station)))</code></pre>
<p>Then, we want to code each fish’s contiguous path as belonging to its own group of encounters so that <code>geom_path()</code> can recognize them as a group when we plot it. A handy way to do this in R is to write a custom function that will apply a grouping variable to each fish’s detections. Bob accomplishes this by using <code>purrr::map()</code> with the <code>rle()</code> function (where rle stands for run-length encoding. Type <code>?rle()</code> into your R console to find out more about it). The following function is designed to apply the run-length encoding function to the 1/0 column for a single fish, and then assign each contiguous group of length encodings a letter variable that we will be able to use with ggplot2 later.</p>
<pre class="r"><code>make_groups &lt;- function(tag, val) {
  r &lt;- rle(val) # where val will be the 0/1 column in the full data frame
  flatten_chr(map(1:length(r$lengths), function(i) { # for 1:length(r$lengths), apply the flatten_chr function to the letter corresponding to the ith value, and then call that object grps
    rep(LETTERS[i], r$lengths[i])
  })) -&gt; grps
  
  sprintf(&quot;%s.%s&quot;, tag, grps) # this just concatenates the tag and the letter values into a single string.
}

# now, apply the above function to the whole dataframe:

group_by(encounters, TagID) %&gt;% 
  mutate(grp = make_groups(TagID, value)) %&gt;% 
  filter(value != 0) %&gt;%  # we don&#39;t want to include rows that aren&#39;t part of the fish&#39;s actual path
  ungroup() -&gt; encounters2

arrange(encounters2, TagID)</code></pre>
<pre><code>## # A tibble: 114 x 5
##     TagID Station value Monitor    grp
##    &lt;fctr&gt;   &lt;chr&gt; &lt;int&gt;  &lt;fctr&gt;  &lt;chr&gt;
##  1   4842 Release     1 Release 4842.A
##  2   4842   I80_1     1   I80_1 4842.A
##  3   4842  Lisbon     1  Lisbon 4842.A
##  4   4842    Rstr     1    Rstr 4842.A
##  5   4842 Base_TD     1 Base_TD 4842.A
##  6   4842     BCE     1     BCE 4842.A
##  7   4842     BCW     1     BCW 4842.A
##  8   4842    BCE2     1    BCE2 4842.A
##  9   4842    BCW2     1    BCW2 4842.A
## 10   4842     MAE     1     MAE 4842.A
## # ... with 104 more rows</code></pre>
<p>We now have a <code>dataframe</code> composed of each fish’s complete paths - let’s plot them! The <code>theme_ipsum()</code> from <span class="citation">[@hrbrmstr's]</span>(<a href="https://github.com/hrbrmstr" class="uri">https://github.com/hrbrmstr</a>) <code>hrbrthemes</code> package takes us a long way towards cleaning up the plot:</p>
<pre class="r"><code>ggplot(encounters2, aes(x = Monitor, y = TagID)) +
  geom_path(aes(group = grp), size = 0.25) +
  geom_point(shape = 18, size = 2) +
  labs(title = &quot;Encounter histories of 25 tagged Chinook salmon smolts&quot;,
       subtitle = &quot;Upstream to downstream&quot;) +
  hrbrthemes::theme_ipsum()</code></pre>
<p><img src="/post/2018-01-05-visualizing-fish-encounter-histories_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>For fun, let’s put some actual fish shapes on the plot going down their paths. There are a few ways to do this, but one is to install the “Le Fish” font (available for download <a href="https://github.com/Myfanwy/ReproducibleExamples/blob/master/encounterhistories/le_fish.zip">here</a>) on your computer, and then register it with R via the <code>extrafonts</code> package. For detailed instructions on how to install a custom font, check out <a href="https://cran.r-project.org/web/packages/extrafont/README.html">this page here</a>.</p>
<p>Once you have the font installed and registered, you can call it onto your plot with <code>geom_text()</code>:</p>
<pre class="r"><code>library(extrafont)</code></pre>
<pre><code>## Registering fonts with R</code></pre>
<pre class="r"><code>ggplot(encounters2, aes(x = Monitor, y = TagID)) +
  geom_path(aes(group = grp), size = 0.25) +
  geom_text(label= &quot;X&quot;, size=9, vjust=0.6, family= &quot;LEFISH&quot;) +
  labs(title = &quot;Encounter histories of 25 tagged Chinook salmon smolts&quot;,
       subtitle = &quot;Upstream to downstream&quot;) +
  hrbrthemes::theme_ipsum()</code></pre>
<p><img src="/post/2018-01-05-visualizing-fish-encounter-histories_files/figure-html/unnamed-chunk-7-1.png" width="960" /></p>

	    </div>
	    
	<div class="about">
	<p> 
     
    </p>
</div>
		<nav id="pagination">
			
			<a class="next" href="/post/2018-01-03-welcome/">Next</a>
		</nav>
	
		        <footer>
		        	Built with <a href="https://github.com/spf13/hugo">Hugo</a> and <a href="https://github.com/rstudio/blogdown">Blogdown</a> 
		        	<p>Based on simple-a theme by Alex Finn</p>
		        </footer>
		    </div>
		  </div>    
		</div>
      </div>
    </div>
</body>

<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + ":change-me";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 4]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
    g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="http://change-me" style="border:0;" alt="" /></p></noscript>


</html>

