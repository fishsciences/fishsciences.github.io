---
title: Visualizing Fish Encounter Histories
author: Myfanwy Johnston, Bob Rudis
date: '2018-01-05'
slug: visualizing-fish-encounter-histories
categories:
  - visualization
  - R
tags:
  - viz
  - ggplot2
editor_options: 
  chunk_output_type: console
---

When working with acoustically-tagged fish, we often want to generate a record of each fishâ€™s "encounters" with the acoustic receivers (also called monitors) in an array.  If this in no way applies to your work, you can think of an encounter history as a simple set of Bernoulli trials for each fish, with successes (1s) or failures (0s).  These encounter histories are simply the translation of a fish's path into a row of 1s and 0s, each corresponding to a positive or negative detection record at a receiver location in the acoustic array.  

An encounter history `dataframe` might look like this:

```{r, echo=FALSE}
d <- structure(list(TagID = c(4842L, 4843L, 4844L, 4845L, 4847L, 4848L, 
4849L, 4850L, 4851L, 4854L, 4855L, 4857L, 4858L, 4859L, 4861L, 
4862L, 4863L, 4864L, 4865L), Release = c(1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L), I80_1 = c(1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L), Lisbon = c(1L, 1L, 1L, 1L, 1L, 1L, 0L, 0L, 0L, 0L, 1L, 
1L, 1L, 1L, 1L, 1L, 0L, 0L, 1L), Rstr = c(1L, 1L, 1L, 1L, 0L, 
1L, 0L, 1L, 0L, 0L, 1L, 1L, 1L, 1L, 1L, 1L, 0L, 0L, 0L), Base_TD = c(1L, 
1L, 1L, 1L, 0L, 0L, 0L, 1L, 0L, 0L, 1L, 1L, 1L, 1L, 1L, 1L, 0L, 
0L, 0L), BCE = c(1L, 1L, 1L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 0L, 
1L, 1L, 0L, 1L, 1L, 0L, 0L, 0L), BCW = c(1L, 1L, 1L, 0L, 0L, 
0L, 0L, 1L, 0L, 0L, 0L, 1L, 1L, 0L, 1L, 1L, 0L, 0L, 0L), MAE = c(1L, 
1L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 1L, 0L, 1L, 0L, 0L, 
0L, 0L), MAW = c(1L, 1L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 
0L, 1L, 0L, 1L, 0L, 0L, 0L, 0L)), class = "data.frame", row.names = c(NA, 
19L), .Names = c("TagID", "Release", "I80_1", "Lisbon", "Rstr", 
"Base_TD", "BCE", "BCW", "MAE", "MAW"))

d[1:10,]
```

Where each row represents a different tagged fish, and each column represents a different receiver location, ordered from the most upstream (the "Release" station") to the most downstream (in this case, Station "MAW").  A  "1" indicates a successful detection at that receiver, and a 0 represents a lack of detection.  A [tidied](https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html) version of this data is in the code below.

A typical pattern of encounter histories for outmigrating juvenile fish is to see the detection rate decline across fish as they migrate downstream and succumb to predation or other mortality factors.  However, some fish will miss one monitor only to be detected at one or more monitors downstream.  Because the missed monitors (which look like 0s or NAs in the dataset) are just as important as the hit monitors, we want to include them in our visualizations.

The following code will allow you to download the sample data and visualize it with ggplot2, provided you have all the packages listed below installed.  The visualization we've chosen is one that utilizes `geom_path()` to connect each fish's string of encounters together.

```{r, echo=TRUE, eval=FALSE}
library(tidyverse)

# download sample data; note that the destfile path defaults to your root directory; adjust filepath as necessary.
download.file('https://github.com/Myfanwy/ReproducibleExamples/raw/master/encounterhistories/fishdata.csv', destfile = "fishdata.csv")

(d <- read_csv("fishdata.csv"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
(d <- read_csv("../../data/fishdata.csv"))
```

The dataframe `d` now has TagID and Station (monitor) as columns, and the 1/0 detection indicator as the `value` column.

First, it's easier to work with both the TagIDs and monitors if they're ordered factors:
```{r}
encounters <- mutate(d,
                     TagID = factor(TagID),
                     Monitor = factor(Station, levels = unique(d$Station)))
```

Then, we want to code each fish's contiguous path as belonging to its own group of encounters so that `geom_path()` can recognize them as a group when we plot it.  A handy way to do this in R is to write a custom function that will apply a grouping variable to each fish's detections.  Bob accomplishes this by using `purrr::map()` with the `rle()` function (where rle stands for run-length encoding.  Type `?rle()` into your R console to find out more about it).  The following function is designed to apply the run-length encoding function to the 1/0 column for a single fish, and then assign each contiguous group of length encodings a letter variable that we will be able to use with ggplot2 later.

```{r}

make_groups <- function(tag, val) {
  r <- rle(val) # where val will be the 0/1 column in the full data frame
  flatten_chr(map(1:length(r$lengths), function(i) { # for 1:length(r$lengths), apply the flatten_chr function to the letter corresponding to the ith value, and then call that object grps
    rep(LETTERS[i], r$lengths[i])
  })) -> grps
  
  sprintf("%s.%s", tag, grps) # this just concatenates the tag and the letter values into a single string.
}

# now, apply the above function to the whole dataframe:

group_by(encounters, TagID) %>% 
  mutate(grp = make_groups(TagID, value)) %>% 
  filter(value != 0) %>%  # we don't want to include rows that aren't part of the fish's actual path
  ungroup() -> encounters2

arrange(encounters2, TagID)
```

We now have a `dataframe` composed of each fish's complete paths - let's plot them!  The `theme_ipsum()` from [@hrbrmstr's](https://github.com/hrbrmstr) `hrbrthemes` package takes us a long way towards cleaning up the plot:

```{r}
ggplot(encounters2, aes(x = Monitor, y = TagID)) +
  geom_path(aes(group = grp), size = 0.25) +
  geom_point(shape = 18, size = 2) +
  labs(title = "Encounter histories of 25 tagged Chinook salmon smolts",
       subtitle = "Upstream to downstream") +
  hrbrthemes::theme_ipsum()
```


For fun, let's put some actual fish shapes on the plot going down their paths.  There are a few ways to do this, but one is to install the "Le Fish" font (available for download [here](https://github.com/Myfanwy/ReproducibleExamples/blob/master/encounterhistories/le_fish.zip)) on your computer, and then register it with R via the `extrafonts` package.  For detailed instructions on how to install a custom font, check out [this page here](https://cran.r-project.org/web/packages/extrafont/README.html).

Once you have the font installed and registered, you can call it onto your plot with `geom_text()`:

```{r, fig.height=10, fig.width=10}
library(extrafont)

ggplot(encounters2, aes(x = Monitor, y = TagID)) +
  geom_path(aes(group = grp), size = 0.25) +
  geom_text(label= "X", size=9, vjust=0.6, family= "LEFISH") +
  labs(title = "Encounter histories of 25 tagged Chinook salmon smolts",
       subtitle = "Upstream to downstream") +
  hrbrthemes::theme_ipsum()

```

